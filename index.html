<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ä¿³å¥ãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼ãƒ¡ãƒ¼ã‚«ãƒ¼</title>
  <style>
    body {
      font-family: "Yu Gothic", sans-serif;
      background: #f0f0f0;
      text-align: center;
    }
    textarea {
      width: 80%;
      height: 50px;
      margin: 10px 0;
      font-size: 16px;
    }
    #haikuDisplay {
      font-size: 20px;
      margin: 15px 0;
      color: #333;
    }
    table {
      margin: 0 auto;
      border-collapse: collapse;
    }
    td {
      width: 30px;
      height: 30px;
      border: 1px solid #ccc;
      text-align: center;
      vertical-align: middle;
      cursor: pointer;
    }
    .note-circle {
      width: 12px;
      height: 12px;
      border: 2px solid #555;
      border-radius: 50%;
      display: inline-block;
      background-color: white;
    }
    .slider-container {
      margin: 10px 0;
    }
    button {
      margin: 5px;
      padding: 5px 10px;
    }
  </style>
</head>
<body>
  <h1>ä¿³å¥ãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼ãƒ¡ãƒ¼ã‚«ãƒ¼</h1>

  <!-- ä¿³å¥å…¥åŠ›æ¬„ -->
  <textarea id="haiku" placeholder="ã²ã‚‰ãŒãªã§ä¿³å¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šãµã‚‹ã„ã‘ã‚„ã€€ã‹ã‚ãšã¨ã³ã“ã‚€ã€€ã¿ãšã®ãŠã¨ï¼‰"></textarea><br>
  <button onclick="placeHaiku()">ä¿³å¥ã‚’ãƒã‚¹ç›®ã«é…ç½®</button>
  <button onclick="playMelody()">å†ç”Ÿ</button>
  <button onclick="stopMelody()">åœæ­¢</button>
  <button onclick="saveJSON()">ä½œå“ã‚’ä¿å­˜ï¼ˆJSONãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰</button>
  <input type="file" id="fileInput">
  <button onclick="resetGrid()">ãƒªã‚»ãƒƒãƒˆ</button>

  <div class="slider-container">
    ãƒ†ãƒ³ãƒ <span id="tempoLabel">120</span> BPM
    <input type="range" id="tempo" min="60" max="240" value="120"
      oninput="document.getElementById('tempoLabel').textContent=this.value"><br>
    éŸ³é‡ <span id="volumeLabel">100</span> %
    <input type="range" id="volume" min="10" max="100" value="100"
      oninput="document.getElementById('volumeLabel').textContent=this.value">
  </div>

  <!-- èª­ã¿è¾¼ã¾ã‚ŒãŸä¿³å¥ã®è¡¨ç¤º -->
  <div id="haikuDisplay"></div>

  <table id="grid"></table>

  <script>
    const pitches = ["é«˜ãƒ¬", "ãƒ‰", "ãƒ©", "ã‚½", "ãƒ•ã‚¡", "ä½ãƒ¬"];
    const grid = document.getElementById("grid");
    let gridData = [];
    let audioCtx = null;
    let currentHaiku = "";

    const noteFreq = {
      "é«˜ãƒ¬": 587.33,
      "ãƒ‰": 523.25,
      "ãƒ©": 440.00,
      "ã‚½": 392.00,
      "ãƒ•ã‚¡": 349.23,
      "ä½ãƒ¬": 293.66
    };

    function initAudio() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
    }

    function createGrid(columns = 10) {
      grid.innerHTML = "";
      let header = grid.insertRow();
      header.insertCell();
      for (let i = 0; i < columns; i++) header.insertCell().textContent = "";
      for (let p of pitches) {
        let row = grid.insertRow();
        let th = row.insertCell();
        th.textContent = p;
        for (let i = 0; i < columns; i++) {
          let cell = row.insertCell();
          cell.onclick = () => toggleCell(cell);
        }
      }
      gridData = Array(pitches.length).fill().map(() => Array(columns).fill(0));
    }

    function toggleCell(cell) {
      const row = cell.parentNode.rowIndex - 1;
      const col = cell.cellIndex - 1;
      gridData[row][col] = gridData[row][col] ? 0 : 1;
      updateCell(cell, gridData[row][col]);
    }

    function updateCell(cell, isOn, circleMode = false) {
      if (circleMode) {
        cell.innerHTML = isOn ? '<span class="note-circle"></span>' : "";
      } else {
        cell.style.background = isOn ? "#4caf50" : "";
      }
    }

    function placeHaiku() {
      const text = document.getElementById("haiku").value.replace(/\s/g, "");
      currentHaiku = text;
      document.getElementById("haikuDisplay").textContent = "ğŸ“ " + text;
      createGrid(text.length);
      for (let i = 0; i < text.length && i < gridData[0].length; i++) {
        const row = i % pitches.length;
        gridData[row][i] = 1;
        updateCell(grid.rows[row + 1].cells[i + 1], true);
      }
    }

    function playMelody() {
      initAudio();
      const tempo = parseInt(document.getElementById("tempo").value);
      const volume = parseInt(document.getElementById("volume").value) / 100;
      let t = audioCtx.currentTime;

      for (let c = 0; c < gridData[0].length; c++) {
        for (let r = 0; r < gridData.length; r++) {
          if (gridData[r][c] === 1) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.value = noteFreq[pitches[r]];
            gain.gain.value = volume;
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(t + (c * 60 / tempo));
            osc.stop(t + (c * 60 / tempo) + 0.3);
          }
        }
      }
    }

    function stopMelody() {
      if (audioCtx) {
        audioCtx.close();
        audioCtx = null;
      }
    }

    function saveJSON() {
      const blob = new Blob(
        [JSON.stringify({ haiku: currentHaiku, grid: gridData })],
        { type: "application/json" }
      );
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = (currentHaiku || "haiku") + ".json";
      a.click();
    }

    function resetGrid() {
      createGrid(gridData[0]?.length || 10);
      document.getElementById("haikuDisplay").textContent = "";
      currentHaiku = "";
    }

    document.getElementById("fileInput").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        const data = JSON.parse(ev.target.result);
        loadFromJSON(data);
      };
      reader.readAsText(file);
    });

    window.onload = () => {
      const params = new URLSearchParams(window.location.search);
      if (params.has("data")) {
        fetch(params.get("data"))
          .then(res => res.json())
          .then(json => loadFromJSON(json))
          .catch(() => createGrid(10));
      } else {
        createGrid(10);
      }
    };

    function loadFromJSON(data) {
      if (data.grid) {
        createGrid(data.grid[0].length);
        gridData = data.grid;
        currentHaiku = data.haiku || "";
        document.getElementById("haikuDisplay").textContent =
          currentHaiku ? "ğŸ“ " + currentHaiku : "";

        const circleMode = data.circleStyle === true || checkOldStyle(data);
        for (let r = 0; r < gridData.length; r++) {
          for (let c = 0; c < gridData[r].length; c++) {
            if (gridData[r][c] === 1) {
              updateCell(grid.rows[r + 1].cells[c + 1], true, circleMode);
            }
          }
        }
      }
    }

    function checkOldStyle(data) {
      return data.grid.some(row => row.some(v => v === 1));
    }
  </script>
</body>
</html>


