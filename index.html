<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>俳句メロディーメーカー</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 20px;
      background: #f0f0f0;
    }
    h1 {
      color: #333;
    }
    textarea {
      width: 80%;
      height: 60px;
      margin: 10px 0;
    }
    table {
      border-collapse: collapse;
      margin: 20px auto;
      background: white;
    }
    td {
      width: 30px;
      height: 30px;
      border: 1px solid #ccc;
      cursor: pointer;
    }
    .slider-container {
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>俳句メロディーメーカー</h1>
  <textarea id="haiku" placeholder="ひらがなで俳句を入力してください（例：ふるいけや　かわずとびこむ　みずのおと）"></textarea>
  <br>
  <button onclick="placeHaiku()">俳句をマス目に配置</button>
  <button onclick="playMelody()">再生</button>
  <button onclick="stopMelody()">停止</button>
  <button onclick="saveJSON()">作品を保存（JSONダウンロード）</button>
  <input type="file" id="fileInput">
  <button onclick="resetGrid()">リセット</button>

  <div class="slider-container">
    <label>テンポ <span id="tempoValue">120</span> BPM</label>
    <input type="range" id="tempo" min="60" max="240" value="120" 
      oninput="document.getElementById('tempoValue').textContent=this.value">
  </div>
  <div class="slider-container">
    <label>音量 <span id="volumeValue">100</span>%</label>
    <input type="range" id="volume" min="0" max="100" value="100"
      oninput="document.getElementById('volumeValue').textContent=this.value">
  </div>

  <table id="grid"></table>

  <script>
    const pitches = ["高レ", "ド", "ラ", "ソ", "ファ", "低レ"];
    const grid = document.getElementById("grid");
    let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let isPlaying = false;
    let currentTimeouts = [];
    let gridData = [];

    const noteFreq = {
      "高レ": 587.33,
      "ド": 523.25,
      "ラ": 440.00,
      "ソ": 392.00,
      "ファ": 349.23,
      "低レ": 293.66
    };

    // グリッドを作成
    function createGrid(columns = 15) {
      grid.innerHTML = "";
      let header = grid.insertRow();
      header.insertCell(); // 左上余白
      for (let i = 0; i < columns; i++) {
        let cell = header.insertCell();
        cell.textContent = "";
      }
      for (let r = 0; r < pitches.length; r++) {
        let row = grid.insertRow();
        let th = row.insertCell();
        th.textContent = pitches[r];
        for (let c = 0; c < columns; c++) {
          let cell = row.insertCell();
          cell.onclick = () => toggleCell(r, c, cell);
        }
      }
      gridData = Array(pitches.length).fill().map(() => Array(columns).fill(0));
    }

    function toggleCell(r, c, cell) {
      if (gridData[r][c] === 0) {
        gridData[r][c] = 1;
        cell.style.background = "#4caf50";
      } else {
        gridData[r][c] = 0;
        cell.style.background = "white";
      }
    }

    // 音を鳴らす
    function playNote(freq, duration, volume) {
      let osc = audioCtx.createOscillator();
      let gainNode = audioCtx.createGain();
      osc.type = "sine";
      osc.frequency.value = freq;
      gainNode.gain.value = volume;
      osc.connect(gainNode).connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + duration);
    }

    function playMelody() {
      if (isPlaying) return;
      isPlaying = true;
      const bpm = document.getElementById("tempo").value;
      const volume = document.getElementById("volume").value / 100;
      const beatDuration = 60 / bpm;

      for (let c = 0; c < gridData[0].length; c++) {
        for (let r = 0; r < pitches.length; r++) {
          if (gridData[r][c] === 1) {
            const freq = noteFreq[pitches[r]];
            const time = audioCtx.currentTime + c * beatDuration;
            let osc = audioCtx.createOscillator();
            let gainNode = audioCtx.createGain();
            osc.type = "sine";
            osc.frequency.value = freq;
            gainNode.gain.value = volume;
            osc.connect(gainNode).connect(audioCtx.destination);
            osc.start(time);
            osc.stop(time + beatDuration);
          }
        }
      }
    }

    function stopMelody() {
      isPlaying = false;
      currentTimeouts.forEach(id => clearTimeout(id));
      currentTimeouts = [];
    }

    function resetGrid() {
      createGrid(gridData[0].length);
    }

    // JSON保存
    function saveJSON() {
      const data = { grid: gridData };
      const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "haiku.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    // JSON読み込み
    document.getElementById("fileInput").addEventListener("change", function (e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function (event) {
        const data = JSON.parse(event.target.result);
        loadFromJSON(data);
      };
      reader.readAsText(file);
    });

    // ✅ 修正版: JSONから復元
    function loadFromJSON(data) {
      if (data.grid) {
        gridData = data.grid;
        createGrid(gridData[0].length);
        for (let r = 0; r < gridData.length; r++) {
          for (let c = 0; c < gridData[r].length; c++) {
            if (gridData[r][c] === 1) {
              grid.rows[r + 1].cells[c + 1].style.background = "#4caf50";
            } else {
              grid.rows[r + 1].cells[c + 1].style.background = "white"; // 空白に戻す
            }
          }
        }
      }
    }

    // URLからJSONを読み込み
    window.onload = function () {
      const params = new URLSearchParams(window.location.search);
      if (params.has("data")) {
        const url = params.get("data");
        fetch(url)
          .then(response => response.json())
          .then(json => loadFromJSON(json))
          .catch(err => console.error("JSON読み込み失敗:", err));
      } else {
        createGrid();
      }
    };
  </script>
</body>
</html>

